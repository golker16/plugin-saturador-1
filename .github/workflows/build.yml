name: build-vst3-windows

on:
  push:
  pull_request:
  release:
    types: [published]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (CMake)
        run: cmake -S . -B build -G "Visual Studio 17 2022" -A x64

      - name: Build (Release)
        run: cmake --build build --config Release --parallel

      - name: Package VST3
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null

          # Solo directorios .vst3 (bundle)
          $bundles = Get-ChildItem -Path build -Recurse -Directory -Filter *.vst3 |
                     Where-Object { $_.FullName -match "\\VST3\\" }

          if (-not $bundles) {
            Write-Host "No .vst3 bundle directories found under build/**/VST3/"
            Get-ChildItem -Path build -Recurse | Select-Object FullName
            exit 1
          }

          foreach ($b in $bundles) {
            $dest = Join-Path dist $b.Name
            if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }
            Copy-Item -Recurse -Force $b.FullName $dest
          }

          # Zip final
          $zipPath = "dist\vst3-windows.zip"
          if (Test-Path $zipPath) { Remove-Item -Force $zipPath }
          Compress-Archive -Path "dist\*.vst3" -DestinationPath $zipPath -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vst3-windows
          path: dist/vst3-windows.zip

